{% extends "base.html" %}

{% block extracss %}
<style>
    html, body {
        height: 100vh;
        margin: 0px;
        padding: 0px;
    }

    .cell {
        border: solid;
        border-width: 1px;
        border-radius: 5px;
        padding: 0.5em;
    }

    .canvas-container {
        height: 100%;
    }

    canvas {
        max-width: 100%;
        max-height: calc(100vh - 150px);;
        margin: auto;
    }
</style>
{% endblock extracss %}

{% block extranavbarstart %}
    <span class="navbar-item is-italic">
        {{ species_pretty_name }}
    </span>
    <span class="navbar-item">
        {{ species_pretty_finder }}
    </span>
{% endblock extranavbarstart %}

{% block extranavbarend %}
    <a class="navbar-item" href="/crop/{{ species.species_key }}/{{ occurrence.key }}/{{ media.id }}">
        Cropper manuellement
    </a>
{% endblock extranavbarend %}

{% block content %}

<section class="section">
    <div class="canvas-container has-text-centered">
        <canvas
            id="canvas"
            width=0
            height=0
            class="blur canvas has-text-centered"
            data-src="/data/medias/{{ media.path | safe }}"
            {% if media.manual_x %}
                data-cropped="true"
                data-x="{{ media.manual_x }}"
                data-y="{{ media.manual_y }}"
                data-width="{{ media.manual_width }}"
                data-height="{{ media.manual_height }}"
            {% elif media.x %}
                data-cropped="true"
                data-x="{{ media.x }}"
                data-y="{{ media.y }}"
                data-width="{{ media.width }}"
                data-height="{{ media.width }}"
            {% else %}
                data-cropped="false"
            {% endif %}
        >
        </canvas>
    </div>
</section>
{% endblock content %}

{% block extrajs %}
<script>
    async function loadImage(src) {
        return new Promise((resolve, reject) => {
            let img = new Image()
            img.onload = () => resolve(img)
            img.onerror = reject
            img.src = src
        })
    }

    async function main() {
        let canvas = document.getElementById('canvas');
        let src = canvas.getAttribute('data-src');
        let img = await loadImage(src);

        let width = canvas.parentElement.clientWidth;
        canvas.width = width;
        canvas.height = width * img.height / img.width;

        let ctx = canvas.getContext('2d');
        let cropped = canvas.getAttribute('data-cropped') === 'true';

        ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);

        if (cropped) {
            let x = parseFloat(canvas.getAttribute('data-x'));
            let y = parseFloat(canvas.getAttribute('data-y'));
            let width = parseFloat(canvas.getAttribute('data-width'));
            let height = parseFloat(canvas.getAttribute('data-height'));

            let scaleX = img.width / canvas.width;
            let scaleY = img.height / canvas.height;

            ctx.beginPath();
            ctx.strokeStyle = "black";
            ctx.lineWidth = 2;
            ctx.rect(
                (x - width / 2) / scaleX - 2,
                (y - height / 2) / scaleY - 2,
                width / scaleX + 4,
                height / scaleY + 4,
            );
            ctx.stroke();

            ctx.beginPath();
            ctx.strokeStyle = "white";
            ctx.lineWidth = 2;
            ctx.rect(
                (x - width / 2) / scaleX,
                (y - height / 2) / scaleY,
                width / scaleX,
                height / scaleY,
            );
            ctx.stroke();
        }
    }

    main();
</script>
{% endblock extrajs %}
