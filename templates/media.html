{% extends "base.html" %}

{% block extracss %}
<style>
    .cell {
        border: solid;
        border-width: 1px;
        border-radius: 5px;
        padding: 0.5em;
    }

</style>
{% endblock extracss %}

{% block content %}
<section class="section">
    <h2 class="title is-4 is-italic">
        {{ species_pretty_name }}
    </h2>
    <h3 class="title is-5">
        {{ species_pretty_finder }}
    </h3>
</section>

<section class="section">
    <div class="columns">
        <div id="column" class="column is-4 is-offset-4">
            <div class="has-text-centered">
                <canvas id="canvas" class=""></canvas>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block extrajs %}
<script>
    async function loadImage(src) {
        return new Promise((resolve, reject) => {
            let img = new Image()
            img.onload = () => resolve(img)
            img.onerror = reject
            img.src = src
        })
    }

    async function main() {
        let img = await loadImage("/data/medias/{{ species_key }}/{{ occurrence_key }}_{{ media_id }}.jpg");
        let width = document.getElementById('column').clientWidth;
        let canvas = document.getElementById('canvas');
        canvas.width = width;
        canvas.height = width * img.height / img.width;

        let scaleX = img.width / canvas.width;
        let scaleY = img.height / canvas.height;

        let ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, img.width, img.height, 0, 0, canvas.width, canvas.height);

        {% if media.x %}
        ctx.strokeStyle = "red";
        ctx.lineWidth = 5;
        ctx.rect(
            ({{ media.x }} - {{ media.width }} / 2) / scaleX,
            ({{ media.y }} - {{ media.height }} / 2) / scaleY,
            {{ media.width }} / scaleX,
            {{ media.height }} / scaleY,
        );
        ctx.stroke();
        {% endif %}
    }

    main();
</script>
{% endblock extrajs %}
